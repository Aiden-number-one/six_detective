define(function(require,exports,module){require("cookie"),require("blockui"),require("uniform"),require("switch"),require("toastr"),require("plugins/jquery-validation/js/jquery.validate");var l,a=require("./kweb"),d={},m=60,g="";window.sessionStorage.getItem("loginErrorCount"),a.kingdom.setValue("x-trace-user-id",a.kingdom.uuid());var e=function(){function t(){$.kingdom.doKoauthAdminAPI("kingdom.retl.get_sys_current_date","v4.0",{},function(e){"1"===e.bcjson.flag&&e.bcjson.items[0]&&function(d){var e={url:window.location.origin+"/retl/rest/admin/v4.0/kingdom.retl.get_auth_info.json",type:"POST",dataType:"json",success:function(e){if(App.unblockUI(),"1"==e.bcjson.flag&&e.bcjson.items&&0<e.bcjson.items.length){var o=e.bcjson.items[0],t=o.date.substring(0,4)+"-"+o.date.substring(4,6)+"-"+o.date.substring(6,8),n=d.substring(0,4),i=d.substring(4,6),r=d.substring(6,8),s=new Date(n+"-"+i+"-"+r).getTime(),a=(new Date(t).getTime()-s)/864e5;a<l&&0<a&&($(".authorizationing").removeClass("hide"),$(".authorizationing span").html(t)),a<0&&($(".authorizationed").removeClass("hide"),$(".authorizationed span").html(t))}},error:function(e){App.unblockUI(),toastr.error(e.bcjson.msg)}};$("#login-authorization").ajaxSubmit(e)}(e.bcjson.items[0].currentDate.substring(0,8))})}$.kingdom.doKoauthAdminAPI(" kingdom.retl.get_sys_param_info","v4.0",{groupNo:"group.authinfo.warn",paramKey:"group.authinfo.warn.deadline"},function(e){var o=e.bcjson.items[0]||e.bcjson;"1"==e.bcjson.flag&&o?(l=1*o.paramRealValue,t()):toastr.error(o.bcjson.msg)});function n(o,t,n){var e=o.data("text")||o.text(),i=0;function r(){clearTimeout(i),o.prop("disabled",!1).removeClass("disabled").text(e)}return o.prop("disabled",!0).addClass("disabled").on("bc.clear",function(){r()}),function(){var e=function(e){var o=Math.floor(e/1e3/60/60/24),t=Math.floor(e/1e3/60/60%24),n=Math.floor(e/1e3/60%60),i=Math.floor(e/1e3%60),r=Math.floor(e/1e3);return{d:o+"天",h:t+"小时",m:n+"分",ss:r+"秒","d:h:m:s":o+"天"+t+"小时"+n+"分"+i+"秒","h:m:s":t+"小时"+n+"分"+i+"秒","m:s":n+"分"+i+"秒"}}(t)[n];o.text(e+"后失效"),t<=0?(t=0,r(),g=""):(t-=1e3,i=setTimeout(arguments.callee,1e3))}(),this}var o=function(){var e=$("input[name=password]").val(),o=$("input[name=username]").val(),t=($("#login-validation").val(),$.kingdom.getParameter("loginErrorCount"));$("input[name=password]").val(a.des.getDes(e));var n={loginName:o,loginPwd:a.des.getDes(e),storeId:"100",ipAddress:"127.0.0.1",loginType:"1",loginFromWay:"0",businessCode:"1001"};a.kingdom.doKoauthAdminAPI("kingdom.retl.set_dis_employee_login","v4.0",n,function(e){"0"==e.bcjson.flag?($.kingdom.setParameter("loginErrorCount",parseInt(t||0)+1),$.kingdom.getParameter("loginErrorCount"),"非法拷贝"===e.bcjson.msg&&(e.bcjson.msg="无效的授权信息"),toastr.error(e.bcjson.msg),$("input[name=password]").val(""),$("input[name=password]").focus(),$("#login-validation").val("")):"1"==e.bcjson.flag&&($.kingdom.setParameter("loginErrorCount","0"),$.kingdom.setParameter("employeeId",e.bcjson.items[0].employeeId),$.kingdom.setParameter("loginName",n.loginName),$.cookie("adminFlagTrue",e.bcjson.items[0].adminFlagTrue),$.cookie("parentDepartmentId",e.bcjson.items[0].currentUserdepartmentId),$.cookie("parentDepartmentType",e.bcjson.items[0].currUserdepartmentType),document.location="/index.html")})};$("body").on("click","#uml-forgetpwd #VerificationCodeId",function(){var e=$("#uml-forgetpwd input[name=loginName]").val();if(!e)return toastr.options={positionClass:"toast-top-center"},toastr.error("请输入登录名！"),void $(this).trigger("bc.clear");var o={};o.loginName=e,o.sysType="cisp",o.loginType="1",n($(this),18e4,"ss"),i(o)});var i=function(e){$.kingdom.doKoauthAdminAPI("kingdom.krcs.set_send_mail_message_reset_pwd","v4.0",e,function(e){var o=e.bcjson.items||e.bcjson;if("0"==e.bcjson.flag)return $("#VerificationCodeId").trigger("bc.clear"),toastr.options={positionClass:"toast-top-center"},g="",void toastr.error(e.bcjson.msg);if("1"==e.bcjson.flag){toastr.options={positionClass:"toast-top-center"},g=$("#uml-forgetpwd input[name=loginName]").val(),toastr.success(e.bcjson.msg);var t=o[0].uniqueID;$("#uml-forgetpwd input[name=uniqueID]").val(t)}})};$("body").on("click","#uml-forgetUserBt",function(){var e={},o=$("#uml-forgetpwd input[name=V_code]").val();if(!o)return toastr.options={positionClass:"toast-top-center"},void toastr.error("验证码不能为空");var t=$("#uml-forgetpwd input[name=uniqueID]").val();if(null==t||""==t)return toastr.options={positionClass:"toast-top-center"},void toastr.error("验证码非法！");e.loginName=$("#uml-forgetpwd input[name=loginName]").val();var n=$("#uml-forgetpwd input[name=loginPwd]").val();if(e.loginName&&e.loginName!=g)toastr.error("登录名不一致，请重新输入！");else{if(!n)return toastr.options={positionClass:"toast-top-center"},void toastr.error("新密码不能为空！");if($("#uml-forgetpwd input[name=loginPwdTwo]").val()!=n)return toastr.options={positionClass:"toast-top-center"},void toastr.error("两次密码不一致！");e.loginPwd=a.des.getDes(n),e.loginType="1",e.exchangeId="1",e.distributorId="100",e.employeeId="230004",e.forgetPwd="true",e.uniqueID=t,e.V_code=o,$.kingdom.doKoauthAdminAPI("kingdom.retl.update_dis_employee_pwd","v4.0",e,function(e){e.bcjson.items||e.bcjson;return"0"==e.bcjson.flag?($("#VerificationCodeId").trigger("bc.clear"),toastr.options={positionClass:"toast-top-center"},void toastr.error(e.bcjson.msg)):"1"==e.bcjson.flag?($("#forget-password").modal("hide"),$("#reset").click(),toastr.options={positionClass:"toast-top-center"},void toastr.success(e.bcjson.msg)):void 0})}}),$("body").on("blur","#uml-forgetpwd input[name=loginPwdTwo]",function(){var e=$("#uml-forgetpwd input[name=loginPwd]").val();return e?$("#uml-forgetpwd input[name=loginPwdTwo]").val()!=e?(toastr.options={positionClass:"toast-top-center"},void toastr.error("两次密码不一致！")):void 0:(toastr.options={positionClass:"toast-top-center"},void toastr.error("新密码不能为空！"))}),$("body").on("blur","#uml-forgetpwd input[name=loginPwd]",function(){var e=$("#uml-forgetpwd input[name=loginPwd]").val();if(e&&!/^(?![^a-zA-Z]+$)(?!\D+$).{6,16}$/.test(e))return toastr.options={positionClass:"toast-top-center"},void toastr.error("请输入6-16位字符（中文占两个字符），至少包含数字、字母(区分大小写)！")}),$("body").on("click","#J_message_time",function(){if($(this).hasClass("green")){var e=$.trim($("#login-username").val());if(!e)return void toastr.info("请输入用户名");r(e,"#messagecode input[name='validation']")}});var r=function(e,t){a.kingdom.doKoauthAdminAPISync("kingdom.krcs.get_message_code_send","v4.0",{exchangeId:"1",distributorId:"100",businessCode:"1001",loginName:e},function(e){if("1"==e.bcjson.flag){var o=e.bcjson.items[0];$(t).val(o.msgCode),m=o.effectiveTime,d.timeinterval=setInterval(function(){$.kingdom.ls.set("codetime",m),m=$.kingdom.ls.get("codetime"),s(m),m--},1e3)}else toastr.error(e.bcjson.msg)})},s=function(e){if(0==e||e<0)return $("#J_message_time").html("发送短信验证码"),$("#J_message_time").removeClass("btn-gray").addClass("green"),void window.clearInterval(d.timeinterval);$("#J_message_time").removeClass("green").addClass("btn-gray"),$("#J_message_time").html(e+"s后重新发送")};return{init:function(){$(".login-form").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!1,rules:{username:{required:!0},password:{required:!0},validation:{required:!0,validateimg:!1}},messages:{username:{required:"用户名不能为空"},password:{required:"密码不能为空"},validation:{required:"验证码不能为空"}},invalidHandler:function(){},highlight:function(e){$(e).closest(".form-group").addClass("has-error")},success:function(e){e.closest(".form-group").removeClass("has-error"),e.remove()},errorPlacement:function(e,o){e.insertAfter(o)},submitHandler:function(){o()}}),$(".login-form input").keypress(function(e){if(13==e.which)return $(".login-form").validate().form()&&o(),!1}),$(".rem-checkbox").change(function(){$(this).prop("checked")?(!0,$("#login-validation").rules("add",{required:!0,validateimg:!1})):(!1,$("#login-validation").rules("remove"))}),$(".rem-checkbox").prop("checked","true").parent().addClass("checked"),$(".login-bg").backstretch(["assets/img/pages/login/bg1.jpg","assets/img/pages/login/bg2.jpg","assets/img/pages/login/bg3.jpg"],{fade:1500,duration:8e3}),$(".js-validation").click(function(){})}}}();jQuery(document).ready(function(){$.kingdom.recommendBrowser(),e.init(),$("#login-username").focus(),$("body").on("click",".indexVersionTip",function(){$(".login-header").addClass("hide")}),0<navigator.userAgent.indexOf("MSIE")&&(0<navigator.userAgent.indexOf("MSIE 6.0")?$(".login-header").removeClass("hide"):0<navigator.userAgent.indexOf("MSIE 7.0")?$(".login-header").removeClass("hide"):0<navigator.userAgent.indexOf("MSIE 8.0")?$(".login-header").removeClass("hide"):0<navigator.userAgent.indexOf("MSIE 9.0")&&alert("ie9"))})});