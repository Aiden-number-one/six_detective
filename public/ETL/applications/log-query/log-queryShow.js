var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};define(function(require,exports,module){require("assets/js/global/tableTree");var D={};function F(e,t){var a;return"B"===t?a="#ed6b75":"R"===t?a="#659be0":"S"===t?a="#3fc9d5":"F"===t?a="#F1C40F":"N"===t&&(a="#bac3d0"),'<span style="color:'+a+'">'+e+"</span>"}function j(e,t,a){return'<span style="margin-right: 10px;" title=\''+e+"' >"+e+("F,B".includes(t)?"<i class='fa fa-info-circle' title='"+a.substring(0,100)+"'></i>":"")+"</span>"}function A(e){return'<span class="execute-error-msg" msg=\''+e.replace(/\'/g,'"')+'\' style="color:#3fc9d5;cursor:pointer;">'+e.substring(0,100)+"</span>"}function r(I){var e=!0,t=!1,a=void 0;try{function r(){var a=S.value;if(!a.parentMonitorId){var n=[{id:a.monitorId,pId:"-1",columns:{"序号":a.orderNo,"节点":{formatter:function(){return j(a.nodeName,a.executeFlag,a.executeMsg)}},"任务名称":a.jobname,"任务类型":a.memberTypeName,"删除":a.deleteNum,"插入":a.insertNum,"开始时间":$.kingdom.toDateTime(a.startTime),"执行时长":$.kingdom.formatMillisecond(a.zxsj),"执行状态":{formatter:function(){return F(a.executeFlagName,a.executeFlag)}},"执行信息(点击显示全部信息)":{formatter:function(){return A(a.executeMsg)}}},children:[]}],e=!0,t=!1,r=void 0;try{function o(){var e=i.value;if(e.parentMonitorId===a.monitorId){var t={id:e.monitorId,pId:e.parentMonitorId,attr:{obj:JSON.stringify(e)},columns:{"序号":e.orderNo,"节点":{formatter:function(){return j(e.nodeName,e.executeFlag,e.executeMsg)}},"任务名称":e.jobname,"任务类型":e.memberTypeName,"删除":e.deleteNum,"插入":e.successNum,"开始时间":$.kingdom.toDateTime(e.startTime),"执行时长":$.kingdom.formatMillisecond(e.zxsj),"执行状态":{formatter:function(){return F(e.executeFlagName,e.executeFlag)}},"执行信息(点击显示全部信息)":{formatter:function(){return A(e.executeMsg)}}},children:[]};n[0].children.push(t)}}for(var i,l=I[Symbol.iterator]();!(e=(i=l.next()).done);e=!0)o()}catch(e){t=!0,r=e}finally{try{!e&&l.return&&l.return()}finally{if(t)throw r}}for(var c=n[0].children,s=0,d=c.length;s<d;s++){var u=!0,m=!1,g=void 0;try{function f(){var e=h.value;if(e.parentMonitorId===c[s].id){var t={id:e.monitorId,pId:e.parentMonitorId,attr:{obj:JSON.stringify(e)},columns:{"序号":e.orderNo,"节点":{formatter:function(){return j(e.nodeName,e.executeFlag,e.executeMsg)}},"任务名称":e.jobname,"任务类型":e.memberTypeName,"删除":e.deleteNum,"插入":e.successNum,"开始时间":$.kingdom.toDateTime(e.startTime),"执行时长":$.kingdom.formatMillisecond(e.zxsj),"执行状态":{formatter:function(){return F(e.executeFlagName,e.executeFlag)}},"执行信息(点击显示全部信息)":{formatter:function(){return A(e.executeMsg)}}},children:[]};n[0].children[s].children.push(t)}}for(var h,b=I[Symbol.iterator]();!(u=(h=b.next()).done);u=!0)f()}catch(e){m=!0,g=e}finally{try{!u&&b.return&&b.return()}finally{if(m)throw g}}var v=n[0].children[s].children,p=!0,y=!1,x=void 0;try{function _(){for(var e=N.value,t=0,a=v.length;t<a;t++)if(e.parentMonitorId===v[t].id){var r={id:e.monitorId,pId:e.parentMonitorId,attr:{obj:JSON.stringify(e)},columns:{"序号":e.orderNo,"节点":{formatter:function(){return j(e.nodeName,e.executeFlag,e.executeMsg)}},"任务名称":e.jobname,"任务类型":e.memberTypeName,"删除":e.deleteNum,"插入":e.successNum,"开始时间":$.kingdom.toDateTime(e.startTime),"执行时长":$.kingdom.formatMillisecond(e.zxsj),"执行状态":{formatter:function(){return F(e.executeFlagName,e.executeFlag)}},"执行信息(点击显示全部信息)":{formatter:function(){return A(e.executeMsg)}}},children:[]};n[0].children[s].children[t].children.push(r)}}for(var N,k=I[Symbol.iterator]();!(p=(N=k.next()).done);p=!0)_()}catch(e){y=!0,x=e}finally{try{!p&&k.return&&k.return()}finally{if(y)throw x}}}return{v:n}}}for(var S,n=I[Symbol.iterator]();!(e=(S=n.next()).done);e=!0){var o=r();if("object"===(void 0===o?"undefined":_typeof(o)))return o.v}}catch(e){t=!0,a=e}finally{try{!e&&n.return&&n.return()}finally{if(t)throw a}}}saveJobid="",saveBatchNo="",D._load=function(){App.initUniform(),App.handleDatePickers(),App.handleDateTimePickers();var e=$("#local-data").data("params");e?(D.getWorkChart2(e),$("#local-data").data("params","")):D.getWorkChart({});var t=sessionStorage.getItem("isJump");$("#header_notification_bar").mouseout(),t?($("#Id-statistics-cat a:nth-child(2)").click().find("label").addClass("active"),$("#Id-statistics-cat a:nth-child(2)").siblings().find("label").removeClass("active"),$("#lg-tab_0-2 .collapse-control").click(),sessionStorage.setItem("isJump",""),$.kingdom.doKoauthAdminAPI("kingdom.retl.get_sys_current_date","v4.0",{},function(e){if("1"===e.bcjson.flag&&e.bcjson.items[0]){var t=e.bcjson.items[0].currentDate.substring(0,8),a=t.substring(0,4)+"-"+t.substring(4,6)+"-"+t.substring(6,8);$("#J_lq_tab2_query_form [name=beginDate]").val(a+" 00:00:00"),$("#J_lq_tab2_query_form [name=endDate]").val(a+" 23:59:59"),$("#J_lq_tab2_query_form [type=submit]").click()}})):D.getLogBatchList(),$("#lq-calendar").fullCalendar(D.options),D.getScheduleList(),D.getExecuteFlag()},D.getWorkChart=function(e){$.kingdom.doKoauthAdminAPI("kingdom.retl.get_all_monitor_log_info","v4.0",e,function(e){var t=e.bcjson.items||e.bcjson;D.workListFirst=t;var a=[],r=[],n=[],o=[],i={xAxis:a,series:r,legendData:o};if("1"==e.bcjson.flag&&t&&0<t.length){saveJobid=t[0].jobId,saveBatchNo=t[0].batchNo,$("#grapy_work_name").html(t[0].jobName),$("#grapy_batch_no").html(t[0].batchNo),D.getThirdBoardData(t[0]);var l={};l.batchNo=t[0].batchNo,l.jobId=t[0].jobId,D.getScheduleSomeList(l);var c={S:"#3fc9d5",F:"#F1C40F",R:"#659be0",B:"#ed6b75",N:"#bac3d0"},s=!0,d=!(D.jobNameArr=[]),u=void 0;try{for(var m,g=t[Symbol.iterator]();!(s=(m=g.next()).done);s=!0){var f=m.value;if(!n[f.executeFlag]){n[f.executeFlag]={};var h={executeFlag:f.executeFlag,name:f.executeFlagName,type:"bar",stack:"时间",label:{},data:[],itemStyle:{normal:{color:c[f.executeFlag]}}};r.push(h),o.push(f.executeFlagName)}}}catch(e){d=!0,u=e}finally{try{!s&&g.return&&g.return()}finally{if(d)throw u}}var b=!0,v=!1,p=void 0;try{for(var y,x=t[Symbol.iterator]();!(b=(y=x.next()).done);b=!0){var _=y.value;if(D.jobNameArr.push("【"+_.batchNo+"】"+_.jobName),a.push($.kingdom.toDateTime(_.endTime)),n[_.executeFlag]){var N=!0,k=!1,I=void 0;try{for(var S,F=r[Symbol.iterator]();!(N=(S=F.next()).done);N=!0){var j=S.value;_.executeFlag==j.executeFlag?j.data.push(_.duration/1e3||0):j.data.push("-")}}catch(e){k=!0,I=e}finally{try{!N&&F.return&&F.return()}finally{if(k)throw I}}}}}catch(e){v=!0,p=e}finally{try{!b&&x.return&&x.return()}finally{if(v)throw p}}D.createWorkGraph(i)}else $("#work_log_grapy").html("<img src='assets/img/nonedata.png' style='margin-left:410px'>")})},D.createWorkGraph=function(e){var t=echarts.init(document.getElementById("work_log_grapy")),a={title:{text:"计划执行日志分析[点击柱状图查看详情]",left:10,textStyle:{fontSize:14}},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(e){for(var t={dataIndex:0,seriesName:"",name:"",value:""},a=0;a<e.length;a++)"-"!=e[a].value&&(t=e[a]);return D.jobNameArr[t.dataIndex]+"<br/>"+t.seriesName+"<br/>"+t.name+" ： "+t.value}},legend:{data:e.legendData},calculable:!0,xAxis:[{type:"category",axisTick:{show:!1},data:e.xAxis}],yAxis:[{type:"value",splitLine:{show:!1},axisLabel:{formatter:"{value} s"}}],dataZoom:[{type:"inside",xAxisIndex:[0],start:0,end:10},{type:"slider",show:!0,xAxisIndex:[0],start:0,end:100}],series:e.series};t.setOption(a),window.onresize=t.resize,t.on("click",function(a){var r={},n="";$.each(D.workListFirst,function(e,t){$.kingdom.toDateTime(t.endTime)==a.name&&(r.batchNo=t.batchNo,r.jobId=t.jobId,n=t.jobName,D.getThirdBoardData(t),saveJobid=t.jobId,saveBatchNo=t.batchNo)}),D.getWorkChart2(r),D.tab1SearchParamsCurrent=r,D.getScheduleSomeList($.extend({pageNumber:"1"},D.tab1SearchParamsCurrent)),$("#grapy_work_name").html(n),$("#grapy_batch_no").html(r.batchNo)})},D.getWorkChart2=function(e){$.kingdom.doKoauthAdminAPI("kingdom.retl.get_current_job_monitor_log_info","v4.0",e,function(e){var t=e.bcjson.items||e.bcjson;D.workListSecond=t;var a=[],r=[],n=[],o=[],i={xAxis:a,series:r};if("1"==e.bcjson.flag&&t&&0<t.length){var l={S:"#3fc9d5",F:"#F1C40F",R:"#659be0",B:"#ed6b75",N:"#bac3d0"},c=!0,s=!(D.jobNameArr=[]),d=void 0;try{for(var u,m=t[Symbol.iterator]();!(c=(u=m.next()).done);c=!0){var g=u.value;if(!n[g.executeFlag]){n[g.executeFlag]={};var f={executeFlag:g.executeFlag,name:g.executeFlagName,type:"bar",stack:"总量",label:{},data:[],itemStyle:{normal:{color:l[g.executeFlag]}}};r.push(f),o.push(g.executeFlagName)}}}catch(e){s=!0,d=e}finally{try{!c&&m.return&&m.return()}finally{if(s)throw d}}var h=!0,b=!1,v=void 0;try{for(var p,y=t[Symbol.iterator]();!(h=(p=y.next()).done);h=!0){var x=p.value;if(D.jobNameArr.push("【"+x.batchNo+"】"+x.jobName),a.push(x.nodeName),n[x.executeFlag]){var _=!0,N=!1,k=void 0;try{for(var I,S=r[Symbol.iterator]();!(_=(I=S.next()).done);_=!0){var F=I.value;x.executeFlag==F.executeFlag?F.data.push(x.duration/1e3||0):F.data.push("-")}}catch(e){N=!0,k=e}finally{try{!_&&S.return&&S.return()}finally{if(N)throw k}}}}}catch(e){b=!0,v=e}finally{try{!h&&y.return&&y.return()}finally{if(b)throw v}}D.createWorkGraph2(i)}else $("#work_log_grapy").html("<img src='assets/img/nonedata.png' style='margin-left:410px'>")})},D.createWorkGraph2=function(e){var t=echarts.init(document.getElementById("work_log_grapy"));option={title:{text:"计划执行日志分析[点击柱状图返回]",left:10,textStyle:{fontSize:14}},color:["#7ccd7c","#f1b967","#63b8fd","#dd6e78"],tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(e){for(var t={dataIndex:0,seriesName:"",name:"",value:""},a=0;a<e.length;a++)"-"!=e[a].value&&(t=e[a]);return D.jobNameArr[t.dataIndex]+"<br/>"+t.seriesName+"<br/>"+t.name+" ：  "+t.value}},legend:{data:e.legendData},calculable:!0,xAxis:[{type:"category",axisTick:{show:!1},data:e.xAxis}],yAxis:[{type:"value",axisLabel:{formatter:"{value} s"}}],dataZoom:[{show:!0,start:0,end:100,zoomOnMouseWheel:!0}],series:e.series},t.setOption(option),window.onresize=t.resize,t.on("click",function(e){var a={};$.each(D.workListSecond,function(e,t){t.executeMsg==t.name&&(a.batchNo=t.batchNo,a.jobId=t.jobId,t.jobName)}),D.getWorkChart(a)})},D.getScheduleSomeList=function(e){var t=e;t.logType="2",$.kingdom.getList({apiName:"kingdom.retl.get_monitor_log_detail_info",apiVision:"v4.0",params:t,tableId:"J_lq_tab1_query_table",template:"log-query/template/single-job-log-list.handlebars",pageSize:"999"})},D.getLogBatchList=function(e){var t=$.extend({},e),a=sessionStorage.getItem("calendarJumpParams");sessionStorage.getItem("calendarJumpParams")&&(t=$.extend({},e,JSON.parse(a))),t.logType="1",$.kingdom.getList({apiName:"kingdom.retl.get_monitor_log_detail_info",apiVision:"v4.0",params:t,tableId:"log_batch_query_list",pageId:"log_query_pages",formName:"J_lq_tab2_query_form",template:"log-query/template/log_batch_list.handlebars",cb:D.getLogBatchList})},D.eventStartTime="",D.eventEndTime="",D.eventCallback="",D.eventScheduleId="",D.eventExecuteStatus="",D.options={header:{right:"prev,next today",left:"title"},defaultDate:(new Date).Format("yyyy-mm-dd"),editable:!0,monthNames:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],eventLimit:!1,eventStartEditable:!0,dayClick:function(e,t,a){console.log("Clicked on: "+e.format()),console.log("Coordinates: "+t.pageX+","+t.pageY),console.log("Current view: "+a.name)},eventClick:function(e){D.displayDetail(e)},eventMouseover:function(){$(this).find(".fc-title").attr("title",$(this).find(".fc-title").html())},eventDrop:function(e,t,a,r,n,o,i,l){console.log(e+t+a+r+n+o+i+l)},events:function(e,t,a,r){var n=e._d.getFullYear().toString()+(e._d.getMonth()+1<10?"0"+(e._d.getMonth()+1):e._d.getMonth()+1)+(e._d.getDate()<10?"0"+e._d.getDate():e._d.getDate()),o=t._d.getFullYear().toString()+(t._d.getMonth()+1<10?"0"+(t._d.getMonth()+1):t._d.getMonth()+1)+(t._d.getDate()<10?"0"+t._d.getDate():t._d.getDate());D.eventStartTime=n,D.eventEndTime=o,D.eventCallback=r;var i={};i.startTime=n,i.endTime=o,i.scheduleId=D.eventScheduleId,i.executeFlag=D.eventExecuteStatus,D.requestScheduleCalendarInfo(i)}},D.requestScheduleCalendarInfo=function(e,a){$.kingdom.doKoauthAdminAPI("kingdom.retl.get_schedule_calendar_info","v4.0",e,function(e){if("1"===e.bcjson.flag){var s=[],t=e.bcjson.items||[];0<t.length&&$.each(t,function(e,t){var a=t.scheduleInfo;if(0!==a.length){var r=0,n=[],o=0,i=[],l=0,c=[];$.each(a,function(e,t){"B"==t.executeFlag?(l++,c.push(t)):"F"==t.executeFlag?(o++,i.push(t)):"S"==t.executeFlag&&(r++,n.push(t))}),0!==r&&s.push({start:t.scheduleDate,end:t.scheduleDate,title:"成功完成("+r+")",currentAllData:n,className:"success-complete"}),0!==o&&s.push({start:t.scheduleDate,end:t.scheduleDate,title:"出错完成("+o+")",currentAllData:i,className:"error-complete"}),0!==l&&s.push({start:t.scheduleDate,end:t.scheduleDate,title:"出错中断("+l+")",currentAllData:c,className:"error-suspend"})}})}a?$("#lq-calendar").fullCalendar("refetchEvents"):D.eventCallback(s)})},D.getScheduleList=function(){$.kingdom.doKoauthAdminAPI("kingdom.retl.get_schedule_info","v4.0",{pageNumber:"1",pageSize:"999"},function(e){if("1"===e.bcjson.flag){var t=e.bcjson.items||[];if(0<t.length){var a="";$.each(t,function(e,t){a=a+"<div style='padding: 4px 12px' scheduleId='"+t.scheduleId+"'>"+t.scheduleName+"</div>"}),$("#lg-schedule-list-menu-calendar").html(a)}}})},D.getExecuteFlag=function(){$.kingdom.doKoauthAdminAPI("kingdom.retl.get_all_dict_data_list","v4.0",{},function(e){if("1"===e.bcjson.flag){var t=(e.bcjson.items||[])[0].EXECUTE_FLAG;if(t){var a="";$.each(t,function(e,t){"B"!==e&&"F"!==e&&"S"!=e||(a=a+"<div style='padding: 4px 12px;' flagId='"+e+"'>"+t+"</div>")}),$("#lg-flag-list-menu-calendar").html(a)}}})},D.displayDetail=function(e){var t="";0<e.currentAllData.length&&(t=e.currentAllData[0].startTimeStr);var a=App.getFormParams("J_lq_tab2_query_form"),r=t.substring(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)+" 00:00:00",n=t.substring(0,4)+"-"+t.slice(4,6)+"-"+t.slice(6,8)+" 23:59:00";$("#J_lq_tab2_query_form input[name=beginDate]").val(r),$("#J_lq_tab2_query_form input[name=endDate]").val(n),$("#Id-statistics-cat [href=#lg-tab_0-2]").click().find("label").addClass("active"),$("#Id-statistics-cat [href=#lg-tab_0-3]").find("label").removeClass("active"),$("#lg-tab_0-2 div[href=#J_lq_tab2_query_block]").click();var o=$.extend({executeFlagName:e.currentAllData[0].executeFlagName},{executeType:"A"});sessionStorage.setItem("calendarJumpParams",JSON.stringify(o)),D.getLogBatchList($.extend(a,o))},D.getTableData=function(e){$("#bottom-content-table").show();var t=$.extend({},e);$.kingdom.doKoauthAdminAPI("kingdom.retl.get_job_detail_flow_info","v4.0",t,function(e){var t=e.bcjson.items||e.bcjson;if("1"==e.bcjson.flag)if($("#J_tableList").jstree("destroy"),0<t.length){D.currentMsgCollection={},$.each(t,function(e,t){D.currentMsgCollection[e]=t.executeMsg,t.errorIndex=e});var a=r(t);$("#log-query-table-tree").tableTree({data:a}),$("#log-query-table-tree").tableTree({widthScale:2,data:a}).openNode($('[pkey="-1"]').attr("key"))}else $("#J_tableList").html("<image src='assets/img/nonedata.png'/>").css("text-align","center");else toastr.error(e.bcjson.msg)})},D.getThirdBoardData=function(t){var e={};e.batchNo=t.batchNo,e.jobId=t.jobId,D.getTableData(e),require.async("./template/perform-rightMiddle-tast.handlebars",function(e){$(".page-log-query #right-content-middle-tast").html(e([t]))})},module.exports=D});