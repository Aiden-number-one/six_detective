var url="http://192.168.14.74:8080/koauth2/applyCfcaCert",CryptoAgent="",CryptoClient="";function Init_Crypto(){try{if(0<=navigator.appName.indexOf("Internet")||0<=navigator.appVersion.indexOf("Trident"))if("x86"==window.navigator.cpuClass){document.getElementById("FakeCryptoAgent").innerHTML='<object id="CryptoAgent" codebase="CryptoKit.CertEnrollment.Pro.x86.cab" classid="clsid:71BB5253-EF2B-4C5B-85FF-1FD6A03C29A6" ></object>'}else document.getElementById("FakeCryptoAgent").innerHTML='<object id="CryptoAgent" codebase="CryptoKit.CertEnrollment.Pro.x64.cab" classid="clsid:9E7B8F05-ADBE-4067-ABC6-28E0230A5C18" ></object>';else document.getElementById("FakeCryptoAgent").innerHTML='<embed id="CryptoAgent" type="application/npCryptoKit.CertEnrollment.Pro.x86" style="height: 0px; width: 0px">';CryptoAgent=document.getElementById("CryptoAgent"),0<=navigator.appName.indexOf("Internet")||0<=navigator.appVersion.indexOf("Trident")?"x86"==window.navigator.cpuClass?document.getElementById("eDiv").innerHTML='<object id="CryptoClient" codebase="CryptoKit.Ultimate.x86.cab" classid="clsid:4C588282-7792-4E16-93CB-9744402E4E98" ></object>':document.getElementById("eDiv").innerHTML='<object id="CryptoClient" codebase="CryptoKit.Ultimate.x64.cab" classid="clsid:B2F2D4D4-D808-43B3-B355-B671C0DE15D4" ></object>':document.getElementById("eDiv").innerHTML='<embed id="CryptoClient" type="application/npCryptoKit.Ultimate.x86" style="height: 0px; width: 0px">',CryptoClient=document.getElementById("CryptoClient")}catch(e){}getcsp_name()}function getAccessToken(){var e=document.getElementById("userName").value,t=document.getElementById("password").value;t=$.des.getDes(t,null);var n="";return $.post(url,{grant_type:"password",client_id:"243589cf6f4470f2387bcdb9d7f5eb6301f3f76243",client_secret:"985607db7ca8a051efa40b6bf54b4af912cbb683954",username:e,password:t},function(e){alert(e.access_token),n=e.access_token,document.getElementById("access_token").value=n},"json"),n}function SelectCertificateOnClick(){var t="",e=document.getElementById("access_token").value;$.post("http://192.168.205.56:8090/koauth2/querryCfcaCert",{access_token:e},function(e){if("10002"==(t=e.bcjson.flag))check_cert();else if("1"==t){serialNo=e.bcjson.items.serialNo,1==check_cert()&&SignMessageOnClick()}else alert(JSON.stringify(e))},"json")}function SignMessageOnClick(){var e='{"bankcode":""}',t="",n=document.getElementById("access_token").value;try{if(t=CryptoClient.SignMsgPKCS7(e,"SHA-1",!1),alert(t),!t){var r;return r=CryptoClient.GetLastErrorDesc(),void alert(r)}}catch(e){return alert(e),void alert("请安装证书")}$.post("http://192.168.205.56:8090/koauth2/rest.json",{timestamp:"2014-10-13 17:33:16",sign:"7DA80F2582CF4D5021866C9AC5724551",v:"v1.0",method:"kingdom.kifp.get_bank_info",client_id:"243589cf6f4470f2387bcdb9d7f5eb6301f3f76243",format:"json",kingdom_param_json:e,access_token:n,cfca_signature:"10011"},function(e){alert(JSON.stringify(e))},"json")}function check_cert(){try{var e=serialNo;CryptoClient.SelectCertificate("","",e);return!0}catch(e){return confirm("您未下载证书？是否安装证书 ")&&http_Post(1),!1}}function CFCA_importSignCert_SingleCert(){var e=document.getElementById("signatuerCert").value,t=document.getElementById("TextContianerName").value,n=CryptoAgent.CFCA_ImportSignCert(1,e,t);return 1==n&&alert("证书导入成功"),n}function http_Post(e){var t="",n="";n=0==e?(t=document.getElementById("csp_Name_usbkey").value,"1"):(t=document.getElementById("csp_Name").value,"2");var r=PKCS10Requisition_SingleCert(t),o=document.getElementById("access_token").value;$.post(url,{access_token:o,cert_csptype:n,p10:r},function(e){"10001"!=e.bcjson.flag&&alert(JSON.stringify(e)),document.getElementById("signatuerCert").value=e.bcjson.items.signatuerCert,1==CFCA_importSignCert_SingleCert()&&SignMessageOnClick()},"json")}function PKCS10Requisition_SingleCert(e){try{var t=e;if(!CryptoAgent.CFCA_SetCSPInfo(2048,t)){var n=CryptoAgent.GetLastErrorDesc();return void alert(n)}if(!CryptoAgent.CFCA_SetKeyAlgorithm("RSA")){n=CryptoAgent.GetLastErrorDesc();return void alert(n)}var r=CryptoAgent.CFCA_PKCS10CertRequisition("CN=certRequisition,O=CFCA TEST CA,C=CN",1,0);if(!r){n=CryptoAgent.GetLastErrorDesc();return void alert(n)}document.getElementById("textareaP10RSASingleCert").value=r;var o=CryptoAgent.CFCA_GetContainer();if(o)return document.getElementById("TextContianerName").value=o,r;n=CryptoAgent.GetLastErrorDesc();return void alert(n)}catch(e){var i=CryptoAgent.GetLastErrorDesc();alert(i)}}function getcsp_name(){try{indexEnhanced=0;var e=document.getElementById("individualorinstitution");if(!e)return;for(var t=0;t<e.length;t++)e.remove(t);var n=CryptoAgent.CFCA_GetCSPInfo();if(!n){var r=CryptoAgent.GetLastErrorDesc();return void alert(r)}var o=n.split("||");for(t=0;t<o.length;t++)if(-1==o[t].indexOf("Microsoft")){var i=document.createElement("OPTION");i.value=o[t],i.text=o[t],e.options.add(i)}e.selectedIndex=indexEnhanced}catch(e){var a=CryptoAgent.GetLastErrorDesc();-1!=a.indexOf("0x00000000")?alert(e.number+e.message):alert(a)}}